<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>modules/oldreddit.js - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    <input type="text" id="nav-search" placeholder="Search" />
    
    
    <h2><a href="index.html">Home</a></h2><h2><a href="https://github.com/toolbox-team/reddit-moderator-toolbox" target="_blank" class="menu-item" >Github</a></h2><h2><a href="https://www.reddit.com/r/toolbox" target="_blank" class="menu-item" >Subreddit</a></h2><h3>Classes</h3><ul><li><a href="Module.html">Module</a><ul class='methods'><li data-type='method'><a href="Module.html#get">get</a></li><li data-type='method'><a href="Module.html#getEnabled">getEnabled</a></li><li data-type='method'><a href="Module.html#init">init</a></li><li data-type='method'><a href="Module.html#set">set</a></li><li data-type='method'><a href="Module.html#setEnabled">setEnabled</a></li></ul></li><li><a href="TBListener.html">TBListener</a><ul class='methods'><li data-type='method'><a href="TBListener.html#clear">clear</a></li><li data-type='method'><a href="TBListener.html#on">on</a></li><li data-type='method'><a href="TBListener.html#start">start</a></li><li data-type='method'><a href="TBListener.html#stop">stop</a></li></ul></li></ul><h3>Global</h3><ul><li><a href="global.html#DISPLAY_BOTTOM">DISPLAY_BOTTOM</a></li><li><a href="global.html#DISPLAY_CENTER">DISPLAY_CENTER</a></li><li><a href="global.html#FEEDBACK_NEGATIVE">FEEDBACK_NEGATIVE</a></li><li><a href="global.html#FEEDBACK_NEUTRAL">FEEDBACK_NEUTRAL</a></li><li><a href="global.html#FEEDBACK_POSITIVE">FEEDBACK_POSITIVE</a></li><li><a href="global.html#ModNotesBadge">ModNotesBadge</a></li><li><a href="global.html#ModNotesPager">ModNotesPager</a></li><li><a href="global.html#ModNotesPopup">ModNotesPopup</a></li><li><a href="global.html#NoteTableRow">NoteTableRow</a></li><li><a href="global.html#RandomFeedback">RandomFeedback</a></li><li><a href="global.html#RandomQuote">RandomQuote</a></li><li><a href="global.html#TBsettingsObject">TBsettingsObject</a></li><li><a href="global.html#actionButton">actionButton</a></li><li><a href="global.html#addModSubsToSidebar">addModSubsToSidebar</a></li><li><a href="global.html#addToSiteTable">addToSiteTable</a></li><li><a href="global.html#addTrophiesToSidebar">addTrophiesToSidebar</a></li><li><a href="global.html#alert">alert</a></li><li><a href="global.html#baseDomain">baseDomain</a></li><li><a href="global.html#browserName">browserName</a></li><li><a href="global.html#buildSha">buildSha</a></li><li><a href="global.html#buildType">buildType</a></li><li><a href="global.html#button">button</a></li><li><a href="global.html#checkForActions">checkForActions</a></li><li><a href="global.html#cleanSubredditName">cleanSubredditName</a></li><li><a href="global.html#clearCache">clearCache</a></li><li><a href="global.html#colorNameToHex">colorNameToHex</a></li><li><a href="global.html#contextTrigger">contextTrigger</a></li><li><a href="global.html#createDeferredProcessQueue">createDeferredProcessQueue</a></li><li><a href="global.html#daysToMilliseconds">daysToMilliseconds</a></li><li><a href="global.html#debounce">debounce</a></li><li><a href="global.html#debugInformation">debugInformation</a></li><li><a href="global.html#defaultNoteLabelValueToLabelType">defaultNoteLabelValueToLabelType</a></li><li><a href="global.html#delay">delay</a></li><li><a href="global.html#displayNotes">displayNotes</a></li><li><a href="global.html#domain">domain</a></li><li><a href="global.html#escapeHTML">escapeHTML</a></li><li><a href="global.html#fetchModSubs">fetchModSubs</a></li><li><a href="global.html#fetchNewsNotes">fetchNewsNotes</a></li><li><a href="global.html#figureOutMulti">figureOutMulti</a></li><li><a href="global.html#filterModdable">filterModdable</a></li><li><a href="global.html#getActions">getActions</a></li><li><a href="global.html#getAllModNotes">getAllModNotes</a></li><li><a href="global.html#getAnonymizedSettings">getAnonymizedSettings</a></li><li><a href="global.html#getCache">getCache</a></li><li><a href="global.html#getContextURL">getContextURL</a></li><li><a href="global.html#getLastVersion">getLastVersion</a></li><li><a href="global.html#getLatestModNote">getLatestModNote</a></li><li><a href="global.html#getModSubs">getModSubs</a></li><li><a href="global.html#getModlog">getModlog</a></li><li><a href="global.html#getRandomNumber">getRandomNumber</a></li><li><a href="global.html#getSetting">getSetting</a></li><li><a href="global.html#getSettingAsync">getSettingAsync</a></li><li><a href="global.html#getSettings">getSettings</a></li><li><a href="global.html#getSubmissionFullname">getSubmissionFullname</a></li><li><a href="global.html#getSubredditColors">getSubredditColors</a></li><li><a href="global.html#getTime">getTime</a></li><li><a href="global.html#getToolboxDevs">getToolboxDevs</a></li><li><a href="global.html#handleMessage">handleMessage</a></li><li><a href="global.html#handleTBThings">handleTBThings</a></li><li><a href="global.html#handleThing">handleThing</a></li><li><a href="global.html#hideModActionsThings">hideModActionsThings</a></li><li><a href="global.html#htmlDecode">htmlDecode</a></li><li><a href="global.html#htmlEncode">htmlEncode</a></li><li><a href="global.html#humaniseDays">humaniseDays</a></li><li><a href="global.html#init">init</a></li><li><a href="global.html#initialLoadPromise">initialLoadPromise</a></li><li><a href="global.html#isConfigValidVersion">isConfigValidVersion</a></li><li><a href="global.html#isEquivalent">isEquivalent</a></li><li><a href="global.html#isModSub">isModSub</a></li><li><a href="global.html#isNewModmail">isNewModmail</a></li><li><a href="global.html#isOldReddit">isOldReddit</a></li><li><a href="global.html#labelColors">labelColors</a></li><li><a href="global.html#labelNames">labelNames</a></li><li><a href="global.html#link">link</a></li><li><a href="global.html#listenerAliases">listenerAliases</a></li><li><a href="global.html#literalRegExp">literalRegExp</a></li><li><a href="global.html#makeCommentThread">makeCommentThread</a></li><li><a href="global.html#makeQueueOverlay">makeQueueOverlay</a></li><li><a href="global.html#makeSingleComment">makeSingleComment</a></li><li><a href="global.html#makeSubmissionEntry">makeSubmissionEntry</a></li><li><a href="global.html#makeUserSidebar">makeUserSidebar</a></li><li><a href="global.html#messageHandlers">messageHandlers</a></li><li><a href="global.html#millisecondsToDays">millisecondsToDays</a></li><li><a href="global.html#minutesToMilliseconds">minutesToMilliseconds</a></li><li><a href="global.html#modbarExists">modbarExists</a></li><li><a href="global.html#moveArrayItem">moveArrayItem</a></li><li><a href="global.html#newModmailSidebar">newModmailSidebar</a></li><li><a href="global.html#niceDateDiff">niceDateDiff</a></li><li><a href="global.html#notification">notification</a></li><li><a href="global.html#overlay">overlay</a></li><li><a href="global.html#pager">pager</a></li><li><a href="global.html#pagerForItems">pagerForItems</a></li><li><a href="global.html#parseComments">parseComments</a></li><li><a href="global.html#parser">parser</a></li><li><a href="global.html#popup">popup</a></li><li><a href="global.html#progressivePager">progressivePager</a></li><li><a href="global.html#purify">purify</a></li><li><a href="global.html#purifyObject">purifyObject</a></li><li><a href="global.html#regExpEscape">regExpEscape</a></li><li><a href="global.html#relativeTime">relativeTime</a></li><li><a href="global.html#reloadIframe">reloadIframe</a></li><li><a href="global.html#reloadToolbox">reloadToolbox</a></li><li><a href="global.html#remove">remove</a></li><li><a href="global.html#removeLastDirectoryPartOf">removeLastDirectoryPartOf</a></li><li><a href="global.html#removeQuotes">removeQuotes</a></li><li><a href="global.html#replaceAll">replaceAll</a></li><li><a href="global.html#replaceTokens">replaceTokens</a></li><li><a href="global.html#saneSort">saneSort</a></li><li><a href="global.html#saneSortAs">saneSortAs</a></li><li><a href="global.html#saveSettingsToBrowser">saveSettingsToBrowser</a></li><li><a href="global.html#searchProfile">searchProfile</a></li><li><a href="global.html#setCache">setCache</a></li><li><a href="global.html#setSetting">setSetting</a></li><li><a href="global.html#setSettingAsync">setSettingAsync</a></li><li><a href="global.html#settings">settings</a></li><li><a href="global.html#settingsToObject">settingsToObject</a></li><li><a href="global.html#shortVersion">shortVersion</a></li><li><a href="global.html#showNote">showNote</a></li><li><a href="global.html#sortBy">sortBy</a></li><li><a href="global.html#standardColors">standardColors</a></li><li><a href="global.html#stringToColor">stringToColor</a></li><li><a href="global.html#submissionFullnamesCache">submissionFullnamesCache</a></li><li><a href="global.html#tbRedditEvent">tbRedditEvent</a></li><li><a href="global.html#textFeedback">textFeedback</a></li><li><a href="global.html#timeConverterRead">timeConverterRead</a></li><li><a href="global.html#title_to_url">title_to_url</a></li><li><a href="global.html#toolboxVersion">toolboxVersion</a></li><li><a href="global.html#toolboxVersionName">toolboxVersionName</a></li><li><a href="global.html#typeNames">typeNames</a></li><li><a href="global.html#unescapeHTML">unescapeHTML</a></li><li><a href="global.html#unescapeJSON">unescapeJSON</a></li><li><a href="global.html#verifiedSettingsSave">verifiedSettingsSave</a></li><li><a href="global.html#watchForURLChanges">watchForURLChanges</a></li><li><a href="global.html#wrapWithLastValue">wrapWithLastValue</a></li><li><a href="global.html#zlibDeflate">zlibDeflate</a></li><li><a href="global.html#zlibInflate">zlibInflate</a></li></ul>
    
</nav>

<div id="main">
    
    <h1 class="page-title">modules/oldreddit.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import $ from 'jquery';

import * as TBCore from '../tbcore.js';
import {Module} from '../tbmodule.jsx';

const self = new Module({
    name: 'Old Reddit',
    id: 'oldreddit',
    alwaysEnabled: true,
}, () => {
    // Looks like we are on old reddit. Activate!
    if (TBCore.isOldReddit) {
        setTimeout(() => {
            thingCrawler();

            window.addEventListener('TBNewThings', () => {
                thingCrawler();
            });
        }, 500);
    }

    if (TBCore.isNewModmail) {
        const $body = $('body');

        $body.on('click', '.icon-user', () => {
            setTimeout(() => {
                newModmailSidebar();
            }, 500);
        });

        $body.on('click', '.Thread__grouped', () => {
            setTimeout(() => {
                newModmailConversationAuthors();
            }, 500);
        });

        window.addEventListener('TBNewPage', event => {
            if (event.detail.pageType === 'modmailConversation') {
                setTimeout(() => {
                    newModmailSidebar();
                    newModmailConversationAuthors();
                }, 500);
            }
        });
    }
});
export default self;

function dispatchApiEvent (element, object) {
    const apiEvent = new CustomEvent('tbReddit', {detail: object});
    try {
        element.dispatchEvent(apiEvent);
    } catch (error) {
        self.log('Could not dispatch event', object);
    }
}

/**
 * Handles `thing` items as they become visible in the viewport.
 * @function
 * @param {IntersectionObserverEntry[]} entries
 * @param {IntersectionObserver} observer
 */
function handleThing (entries, observer) {
    entries.forEach(async entry => {
        // The observer fires for everything on page load.
        // This makes sure that we really only act on those items that are visible.
        if (!entry.isIntersecting) {
            return;
        }

        // Element is visible, we only want to handle it once. Stop observing.
        observer.unobserve(entry.target);
        const $thing = $(entry.target);

        // If the element's parent is updated, sometimes it gets emitted again anyway.
        // Check for existing containers and avoid adding duplicates.
        if ($thing.find('> .entry > .tb-jsapi-container').length) {
            return;
        }

        const info = await TBCore.getThingInfo($thing);

        requestAnimationFrame(() => {
            const $jsApiThingPlaceholder = $('&lt;div class="tb-jsapi-container">&lt;/div>').appendTo(
                $thing.find('.entry:first'),
            );
            $jsApiThingPlaceholder.append('&lt;span data-name="toolbox">');
            const jsApiThingPlaceholder = $jsApiThingPlaceholder[0];
            $thing.find('.entry:first .author:first, .entry:first .tagline:first > span:contains("[deleted]")').after(
                '&lt;span class="tb-jsapi-author-container">&lt;/span>',
            );
            const $jsApiPlaceholderAuthor = $thing.find('.tb-jsapi-author-container');
            $jsApiPlaceholderAuthor.append('&lt;span data-name="toolbox">');
            const jsApiPlaceholderAuthor = $jsApiPlaceholderAuthor[0];

            if (!$jsApiThingPlaceholder.length) {
                return;
            }

            if (info.kind === 'submission') {
                if (!$jsApiThingPlaceholder.hasClass('tb-frontend-container')) {
                    const detailObject = {
                        type: 'TBpost',
                        data: {
                            author: info.author || '[deleted]',
                            id: info.id,
                            isRemoved: info.ham || info.spam,
                            permalink: `https://www.reddit.com/${
                                info.postlink.replace(/https?:\/\/...?\.reddit\.com\/?/, '').replace(/^\//, '')
                            }`,
                            subreddit: {
                                name: info.subreddit,
                                type: info.subredditType,
                            },
                        },
                    };

                    dispatchApiEvent(jsApiThingPlaceholder, detailObject);
                }
                // We don't want to send events for things already handled.
                if (!$jsApiPlaceholderAuthor.hasClass('tb-frontend-container')) {
                    const detailObject = {
                        type: 'TBpostAuthor',
                        data: {
                            author: info.author || '[deleted]',
                            post: {
                                id: info.id,
                            },
                            subreddit: {
                                name: info.subreddit,
                                type: info.subredditType,
                            },
                        },
                    };
                    dispatchApiEvent(jsApiPlaceholderAuthor, detailObject);
                }
            }

            if (info.kind === 'comment') {
                // Comment
                if (!$jsApiThingPlaceholder.hasClass('tb-frontend-container')) {
                    const detailObject = {
                        type: 'TBcommentOldReddit',
                        data: {
                            author: info.author || '[deleted]',
                            post: {
                                id: info.postID,
                            },
                            isRemoved: info.ham || info.spam,
                            id: info.id,
                            subreddit: {
                                name: info.subreddit,
                                type: info.subredditType,
                            },
                        },
                    };

                    dispatchApiEvent(jsApiThingPlaceholder, detailObject);
                }
                // Author
                // We don't want to send events for things already handled.
                if (!$jsApiPlaceholderAuthor.hasClass('tb-frontend-container')) {
                    const detailObject = {
                        type: 'TBcommentAuthor',
                        data: {
                            author: info.author || '[deleted]',
                            post: {
                                id: info.postID,
                            },
                            comment: {
                                id: info.id,
                            },
                            subreddit: {
                                name: info.subreddit,
                                type: info.subredditType,
                            },
                        },
                    };
                    dispatchApiEvent(jsApiPlaceholderAuthor, detailObject);
                }
            }
        });
    });
}

const viewportObserver = new IntersectionObserver(handleThing, {
    rootMargin: '200px',
});

function thingCrawler () {
    const $things = $('div.content .thing:not(.tb-seen) .entry').closest('.thing');
    $things.each(function () {
        requestAnimationFrame(() => {
            $(this).addClass('tb-seen');
            viewportObserver.observe(this);
        });
    });
}

function newModmailConversationAuthors () {
    const $body = $('body');
    const subreddit = $body.find('.ThreadTitle__community').text();
    $body.find('.Thread__message:not(.tb-seen)').each(function () {
        const $this = $(this);
        $this.addClass('tb-seen');
        const $jsApiThingPlaceholder = $(`
                &lt;span class="tb-jsapi-container">
                    &lt;span data-name="toolbox">&lt;/span>
                &lt;/span>
            `).insertAfter($this.find('.Message__divider').eq(0));
        const jsApiThingPlaceholder = $jsApiThingPlaceholder[0];

        const authorHref = $this.find('.Message__header .Message__author').attr('href');
        const author = authorHref === undefined ? '[deleted]' : authorHref.replace(/.*\/user\/([^/]+).*/, '$1');
        const idDetails = $this.find('.m-link').attr('href').match(/\/mail\/.*?\/(.*?)\/(.*?)$/i);

        const detailObject = {
            type: 'TBmodmailCommentAuthor',
            data: {
                author,
                post: {
                    id: idDetails[1],
                },
                comment: {
                    id: idDetails[2],
                },
                subreddit: {
                    name: subreddit,
                },
            },
        };

        dispatchApiEvent(jsApiThingPlaceholder, detailObject);
    });
}

/**
 * Makes sure to fire a jsAPI `TBuserHovercard` event for new modmail sidebar instances.
 * @function
 */
function newModmailSidebar () {
    setTimeout(() => {
        const $body = $('body');
        if ($body.find('.ThreadViewer').length) {
            const $modmailSidebar = $body.find(
                '.ThreadViewer__infobar:not(.tb-seen), .ThreadViewerHeader__infobar:not(.tb-seen), .InfoBar__idCard:not(.tb-seen)',
            );
            const jsApiPlaceHolder = `
                &lt;div class="tb-jsapi-container tb-modmail-sidebar-container">
                    &lt;div class="InfoBar__recentsTitle">Toolbox functions:&lt;/div>
                    &lt;span data-name="toolbox">&lt;/span>
                &lt;/div>
            `;
            $modmailSidebar.each(async function () {
                const $infobar = $(this);
                $infobar.addClass('tb-seen');
                const info = await TBCore.getThingInfo(this, true);
                const $jsApiThingPlaceholder = $(jsApiPlaceHolder).appendTo($infobar);

                const jsApiThingPlaceholder = $jsApiThingPlaceholder[0];

                const detailObject = {
                    type: 'TBuserHovercard',
                    data: {
                        user: {
                            username: info.user || '[deleted]',
                        },
                        contextID: info.id,
                        subreddit: {
                            name: info.subreddit,
                        },
                    },
                };

                dispatchApiEvent(jsApiThingPlaceholder, detailObject);
            });
        }
    }, 500);
}
</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 4.0.2</a> on Sat Dec 14 2024 16:43:51 GMT+0000 (Coordinated Universal Time) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>

<script src="scripts/search.js" defer></script>



</body>
</html>
